---
title: "aggregated_sdg_status"
author: "Connor Flynn"
date: "8/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(dplyr)
library(missRanger)
library(randomForest)
library(edarf)
library(janitor)
library(caret)

options(set.seed(3))
```

```{r}
set.seed(3)
```




Step 1: Read in data that is summarized by taking the most recent year of data for each indicator/SIDS. If there are multiple indicator values for the most recent year/SIDS, the mean of those values is taken.

```{r}
sdg_indicators <- read_csv(here("most_recent/data_cleaned_and_summarized/sdg_indicators_joined_most_recent.csv"))
```


Step 2: Impute this data using random forest imputation with the missRanger package

Determine how much data we want to impute
  - Here, I decided that I only want to include columns (indicators) in which at least 40% of the SIDS have data for
```{r}
sdg_indicators_less_na <- sdg_indicators[, which(colMeans(!is.na(sdg_indicators)) > 0.4)]
```


Impute using missRanger function (Random Forest Imputation)
```{r, message=FALSE}
sdg_indicators_missRanger <- missRanger(sdg_indicators_less_na, 
                                        formula = . ~ ., 
                                        num.trees = 1000,
                                        seed = 3,
                                        returnOOB = TRUE
                                      )
```



Step 3: Read in data from the Sustainable Development Report 2022 for the most recent goal classification(color) for each SIDS/SDG


```{r}
sdg_report_classifier_data <- read_csv(here("data/sdg_data/sustainable_development_report_2022.csv"))
```



Clean, Select Classifier Data

```{r}
sdg_report_classifier_data <- clean_names(sdg_report_classifier_data)
```

```{r}
sdg_report_classifier_data <- sdg_report_classifier_data %>%
     mutate(country = recode(country, 
                            "Bahamas, The" = 'Bahamas',
                             "Micronesia, Fed. Sts." = 	"Micronesia_(Federated_States_of)",
                            "St. Kitts and Nevis" = 	"Saint_Kitts_and_Nevis",
                            	"St. Lucia" = 	"Saint_Lucia", 
                            	"St. Vincent and the Grenadines" = "Saint_Vincent_and_the_Grenadines"
                            
                            ))
```



```{r}
sdg_report_classifier_data$country <- gsub(" ", "_", sdg_report_classifier_data$country)
```

```{r}
sdg_report_classifier_data <- sdg_report_classifier_data %>%
  rename(geo_area_name = country)
```


```{r}
sdg_report_classifier_data <- sdg_report_classifier_data %>% 
  select(geo_area_name, 
goal_1_dash,
goal_2_dash,
goal_3_dash,
goal_4_dash,
goal_5_dash,
goal_6_dash,
goal_7_dash,
goal_8_dash,
goal_9_dash,
goal_10_dash,
goal_11_dash,
goal_12_dash,
goal_13_dash,
goal_14_dash,
goal_15_dash,
goal_16_dash,
goal_17_dash)
```



Left join to match Sustainable Development Report SIDS(37) with all SIDS(54)
```{r}
sdg_report_classifier_data <- left_join(sdg_indicators, sdg_report_classifier_data, by = "geo_area_name")
```




```{r}
sdg_report_classifier_data <- sdg_report_classifier_data %>% 
  select(geo_area_name, 
goal_1_dash,
goal_2_dash,
goal_3_dash,
goal_4_dash,
goal_5_dash,
goal_6_dash,
goal_7_dash,
goal_8_dash,
goal_9_dash,
goal_10_dash,
goal_11_dash,
goal_12_dash,
goal_13_dash,
goal_14_dash,
goal_15_dash,
goal_16_dash,
goal_17_dash)
```

Drop SIDS that were not a part of the 2022 Sustainable Development Report
```{r}
sdg_report_classifier_data <- drop_na(sdg_report_classifier_data)
```


```{r}
sdg_report_classifier_data_matrix <- sdg_report_classifier_data %>% 
  select(-geo_area_name)
  
```


```{r}
sdg_report_classifier_data_matrix[sdg_report_classifier_data_matrix == "yellow"] <- "green"

sdg_report_classifier_data_matrix[sdg_report_classifier_data_matrix == "orange"] <- "green"

sdg_report_classifier_data_matrix[sdg_report_classifier_data_matrix == "grey"] <- "red"
```

```{r}
# model.matrix(~0+., data=sdg_report_classifier_data_matrix) %>% 
#   cor(use="pairwise.complete.obs") %>% 
#   ggcorrplot(show.diag = F, type = "lower", lab=TRUE, lab_size=1, 
# tl.cex = 7)
```


Step 4: Join Step 1 Data with Step 3 Data

Join SIDS classification data with tier 1 and tier 2 indicator data for 37 SIDS
```{r}
sdg_report_classifier_data_missRanger_sdg_indicators <- left_join(sdg_report_classifier_data, sdg_indicators_missRanger, by = "geo_area_name")
```


Join Isolation Data
```{r}
isolation <- read_csv(here("data/sdg_data/isolation_evi.csv"))
```

```{r}
isolation <- isolation %>%
  rename(geo_area_name = Country_EVI)
```


```{r}
isolation$geo_area_name <- gsub(" ", "_", isolation$geo_area_name)
```


```{r}
isolation <- isolation %>%
     mutate(geo_area_name = recode(geo_area_name, 
                            "Bahama" = 'Bahamas',
                             "Fed._States_Micronesia" = 	"Micronesia_(Federated_States_of)",
                            "St._Kitts_and_Nevis" = 	"Saint_Kitts_and_Nevis",
                            	"St._Vincent_&_Grenadines" = "Saint_Vincent_and_the_Grenadines",
                            "Antigua_&_Barbuda" = "Antigua_and_Barbuda",
                            "Sao_Tome_&_Principe" =  "Sao_Tome_and_Principe",
                            "Cape_Verde" = "Cabo_Verde",
                            "Dominican_Rep" = "Dominican_Republic"
                            
                            ))
```




```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation <- left_join(sdg_report_classifier_data_missRanger_sdg_indicators, isolation, by = "geo_area_name")

sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  select(geo_area_name, ISOL)

# Timor Leste - 575
# Dominica - 568

sdg_report_classifier_data_missRanger_sdg_indicators_isolation <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>%                               # Replacing values
  mutate(ISOL = replace(ISOL, geo_area_name == "Dominica", 568))

sdg_report_classifier_data_missRanger_sdg_indicators_isolation <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>%                               # Replacing values
  mutate(ISOL = replace(ISOL, geo_area_name == "Timor-Leste", 575))

```


```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  remove_rownames %>% 
  column_to_rownames(var="geo_area_name")
```



Aggregate SDG Status (Color)

Green = Green/Yellow/Orange
Red = Red/Grey



```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation[sdg_report_classifier_data_missRanger_sdg_indicators_isolation == "yellow"] <- "green"
```

```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation[sdg_report_classifier_data_missRanger_sdg_indicators_isolation == "orange"] <- "red"
```

```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation[sdg_report_classifier_data_missRanger_sdg_indicators_isolation == "grey"] <- "red"
```












Step 5: Run Random Forest Classification Models predicting the color(classification) of each SDG for each SIDS

What are the drivers/most important predictors of the status(color) of a SIDS two lowest performing indicators per SDG?

```{r}
sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_1_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_1_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_2_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_2_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_3_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_3_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_4_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_4_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_5_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_5_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_6_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_6_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_7_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_7_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_8_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_8_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_9_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_9_dash)


sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_10_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_10_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_11_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_11_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_12_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_12_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_13_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_13_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_14_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_14_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_15_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_15_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_16_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_16_dash)

sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_17_dash <- as.factor(sdg_report_classifier_data_missRanger_sdg_indicators_isolation$goal_17_dash)


```



Goal 1


What are the Tier 1 Indicators for this Goal? (What are we really predicting)

Indicators 
- poverty headcount ratio at $1.90/day (%)
- poverty headcount ratio at $3.20/day (%)
- poverty rate after taxes and transfers


```{r}
missRanger_rf_goal1_dash <- randomForest(goal_1_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE, ntree = 500)
```


```{r}
missRanger_rf_goal1_dash
```


Partial Plot

```{r}
df_rf <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal1_dash))

```





```{r}
imp_df <- data.frame(importance(missRanger_rf_goal1_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df <- imp_df %>% 
  mutate(names = rownames(imp_df)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm <- as.character(imp_df$names)[3]
# Get partial depedence values for top predictors
pd_df <- partial_dependence(fit = missRanger_rf_goal1_dash,
                         vars = nm,
                         data = df_rf)
                         # n = c(100, 200))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df)
```

```{r}
perfectPartialPlot <- function(df, x, y){
  
  # Need string for aes_string()
  centile <- "centile"
  
  # Save marginal probabilities as separate data frame
  vote_prop <- df %>% 
    select(y) %>% 
    mutate(row = row_number())
  
  # Gather predictor centiles into a single column and join vote_prop
  pd_tidy <- df %>% 
    select(x) %>% 
    gather(x, key = "predictor", value = "centile") %>% 
    na.omit() %>% 
    mutate(row = row_number()) %>% 
    left_join(vote_prop, by = "row")
  
  # Create the perfect partial plot
  ggplot(pd_tidy, aes_string(x = centile, y = y)) +
    geom_line(lwd = 1.25) +
    labs(title = "Partial Dependence",
         x = "",
         y = paste("Proportion of votes for", y)) +
    facet_wrap(~predictor, scale = "free") +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) +
    theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  scale_color_manual(values=c("#E69F00"))
  
}
```

```{r}
perfectPartialPlot(df = pd_df, x = nm, y = "green")
```



```{r}
ImpData_missRanger_rf_goal1_dash <- as.data.frame(importance(missRanger_rf_goal1_dash))
ImpData_missRanger_rf_goal1_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal1_dash)








ImpData_missRanger_rf_goal1_dash_highest_mse <- ImpData_missRanger_rf_goal1_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal1_dash_highest_mse <- ImpData_missRanger_rf_goal1_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal1_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
s <- ggplot(sdg_report_classifier_data_missRanger_sdg_indicators_isolation, aes(x = 	
proportion_of_youth_not_in_education_employment_or_training_by_sex_and_age_percent,
                                                y = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation)), label = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation)) +
  geom_point()

ggplotly(s)
```

```{r}
s <- ggplot(sdg_report_classifier_data_missRanger_sdg_indicators_isolation, aes(x = employed_population_below_international_poverty_line_by_sex_and_age_percent, y = 
       proportion_of_youth_not_in_education_employment_or_training_by_sex_and_age_percent, label = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation))) + 
geom_point()
  
ggplotly(s)
```


Goal 2 


What are the Tier 1 Indicators for this Goal? (What are we really predicting)

Indicators
- Prevalence of undernourishment (%)
- Prevalence of stunting in children under 5 years of age (%)
- Prevalence of wasting in children under 5 years of age (%)
- Prevalence of obesity, BMI ≥ 30 (% of adult population)
- Human Trophic Level (best 2-3 worst)
- Cereal yield (tonnes per hectare of harvested land)
- Sustainable Nitrogen Management Index (best 0-1.41 worst)
- Yield gap closure (% of potential yield)
- Exports of hazardous pesticides (tonnes per million population)




```{r}
missRanger_rf_goal2_dash<- randomForest(goal_2_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal2_dash
```

```{r}
df_rf_2 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal2_dash))

```





```{r}
imp_df_2 <- data.frame(importance(missRanger_rf_goal2_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_2 <- imp_df_2 %>% 
  mutate(names = rownames(imp_df_2)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_2 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_2 <- as.character(imp_df_2$names)[1:16]
# Get partial depedence values for top predictors
pd_df_2 <- partial_dependence(fit = missRanger_rf_goal2_dash,
                         vars = nm_2,
                         data = df_rf_2)
                         # n = c(100, 200))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_2)
```


```{r}
perfectPartialPlot(df = pd_df_2, x = nm_2, y = "green")
```





















```{r}
ImpData_missRanger_rf_goal2_dash <- as.data.frame(importance(missRanger_rf_goal2_dash))
ImpData_missRanger_rf_goal2_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal2_dash)







ImpData_missRanger_rf_goal2_dash_highest_mse <- ImpData_missRanger_rf_goal2_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal2_dash_highest_mse <- ImpData_missRanger_rf_goal2_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal2_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```


Goal 3

What are the Tier 1 Indicators for this Goal? (What are we really predicting)


Indicators 
- Maternal mortality rate (per 100,000 live births) 
- Neonatal mortality rate (per 1,000 live births)
- Mortality rate, under-5 (per 1,000 live births)
- Incidence of tuberculosis (per 100,000 population)
- New HIV infections (per 1,000 uninfected population)
- Age-standardized death rate due to cardiovascular disease, cancer, diabetes, or chronic respiratory disease in adults aged 30–70 years (%)
- Age-standardized death rate attributable to household air pollution and ambient air pollution (per 100,000 population)
- Traffic deaths (per 100,000 population)
- Life expectancy at birth (years)
- Adolescent fertility rate (births per 1,000 females aged 15 to 19)
- Births attended by skilled health personnel (%)
- Surviving infants who received 2 WHO-recommended vaccines (%)
- Universal health coverage (UHC) index of service coverage (worst 0-100 best)
- Subjective well-being (average ladder score, worst 0-10 best)
- Gap in life expectancy at birth among regions (years)
- Gap in self-reported health status by income (percentage points)
- Daily smokers (% of population aged 15 and over)




```{r}
missRanger_rf_goal3_dash<- randomForest(goal_3_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal3_dash
```


```{r}
df_rf_3 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal3_dash))

```





```{r}
imp_df_3 <- data.frame(importance(missRanger_rf_goal3_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_3 <- imp_df_3 %>% 
  mutate(names = rownames(imp_df_3)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_3 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_3 <- as.character(imp_df_3$names)[1:12]
# Get partial depedence values for top predictors
pd_df_3 <- partial_dependence(fit = missRanger_rf_goal3_dash,
                         vars = nm_3,
                         data = df_rf_3)
                         # n = c(100, 300))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_3)
```


```{r}
perfectPartialPlot(df = pd_df_3, x = nm_3, y = "green") 
```

```{r}
ImpData_missRanger_rf_goal3_dash <- as.data.frame(importance(missRanger_rf_goal3_dash))
ImpData_missRanger_rf_goal3_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal3_dash)






ImpData_missRanger_rf_goal3_dash_highest_mse <- ImpData_missRanger_rf_goal3_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal3_dash_highest_mse <- ImpData_missRanger_rf_goal3_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal3_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```


Goal 4 

Indicators
- Participation rate in pre-primary organized learning (% of children aged 4 to 6)
- Net primary enrollment rate (%)
- Lower secondary completion rate (%)
- Literacy rate (% of population aged 15 to 24)
- Tertiary educational attainment (% of population aged 25 to 34)
- PISA score (worst 0-600 best)
- Variation in science performance explained by socio-economic status (%)
- Underachievers in science (% of 15-year-olds) 




```{r}
missRanger_rf_goal4_dash<- randomForest(goal_4_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal4_dash
```

```{r}
df_rf_4 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal4_dash))

```





```{r}
imp_df_4 <- data.frame(importance(missRanger_rf_goal4_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_4 <- imp_df_4 %>% 
  mutate(names = rownames(imp_df_4)) %>% 
  arrange(desc(MeanDecreaseAccuracy))




# Plot mean decreased accuracy
imp_df_4 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  theme_minimal() +
  scale_fill_brewer(palette="Dark2") +
  coord_flip() +
  labs(title = "Variable Importance in Predicting SDG 4 Status",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "bold"),
        axis.text.y  = element_text(size = 5, color = "black")) 

```


```{r}
ggplot(sdg_indicators, aes(x = ilo_proportion_of_mothers_with_newborns_receiving_maternity_cash_benefit_percent, 
                           y = geo_area_name)) +
  geom_point()
```

```{r}
# Save top predictor names as character vector
nm_4 <- as.character(imp_df_4$names)[1:12]
# Get partial depedence values for top predictors
pd_df_4 <- partial_dependence(fit = missRanger_rf_goal4_dash,
                         vars = nm_4,
                         data = df_rf_4)
                         # n = c(100, 400))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_4) +
  theme_minimal() +
  scale_color_brewer(palette="Dark2") +
  labs(title = "Partial Dependence Plot Describing Maternity Benefits and SDG4 Attainment")
```


```{r}
perfectPartialPlot(df = pd_df_4, x = nm_4, y = "green") 

```










```{r}
ImpData_missRanger_rf_goal4_dash <- as.data.frame(importance(missRanger_rf_goal4_dash))
ImpData_missRanger_rf_goal4_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal4_dash)



ImpData_missRanger_rf_goal4_dash





ImpData_missRanger_rf_goal4_dash_highest_mse <- ImpData_missRanger_rf_goal4_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal4_dash_highest_mse <- ImpData_missRanger_rf_goal4_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal4_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
missRanger_rf_goal4_reading_math<- randomForest(proportion_of_teachers_with_the_minimum_required_qualifications_by_education_level_and_sex_percent ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```

```{r}
missRanger_rf_goal4_reading_math
```
```{r}
ggplot(sdg_indicators, aes(x = participation_rate_in_organized_learning_one_year_before_the_official_primary_entry_age_by_sex_percent,
                            y = ilo_proportion_of_mothers_with_newborns_receiving_maternity_cash_benefit_percent)) +
  geom_point()
```


Goal 5 

Indicators

- Demand for family planning satisfied by modern methods (% of females aged 15 to 49)
- Ratio of female-to-male mean years of education received (%)
- Ratio of female-to-male labor force participation rate (%)
- Seats held by women in national parliament (%)
- Gender wage gap (% of male median wage)



```{r}
missRanger_rf_goal5_dash<- randomForest(goal_5_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal5_dash
```




```{r}
df_rf_5 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal5_dash))

```





```{r}
imp_df_5 <- data.frame(importance(missRanger_rf_goal5_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_5 <- imp_df_5 %>% 
  mutate(names = rownames(imp_df_5)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_5 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_5 <- as.character(imp_df_5$names)[1:12]
# Get partial depedence values for top predictors
pd_df_5 <- partial_dependence(fit = missRanger_rf_goal5_dash,
                         vars = nm_5,
                         data = df_rf_5)
                         # n = c(100, 500))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_5)
```


```{r}
perfectPartialPlot(df = pd_df_5, x = nm_5, y = "green")
```







```{r}
ImpData_missRanger_rf_goal5_dash <- as.data.frame(importance(missRanger_rf_goal5_dash))
ImpData_missRanger_rf_goal5_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal5_dash)








ImpData_missRanger_rf_goal5_dash_highest_mse <- ImpData_missRanger_rf_goal5_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal5_dash_highest_mse <- ImpData_missRanger_rf_goal5_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal5_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```

Goal 6 

Indicators

- Population using at least basic drinking water services (%)
- Population using at least basic sanitation services (%)
- Freshwater withdrawal (% of available freshwater resources)
- Anthropogenic wastewater that receives treatment (%)
- Scarce water consumption embodied in imports (m3 H2O eq/capita)
- Population using safely managed water services (%)
- Population using safely managed sanitation services (%)



```{r}
missRanger_rf_goal6_dash<- randomForest(goal_6_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal6_dash
```

```{r}
df_rf_6 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal6_dash))

```





```{r}
imp_df_6 <- data.frame(importance(missRanger_rf_goal6_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_6 <- imp_df_6 %>% 
  mutate(names = rownames(imp_df_6)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_6 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_6 <- as.character(imp_df_6$names)[1:7]
# Get partial depedence values for top predictors
pd_df_6 <- partial_dependence(fit = missRanger_rf_goal6_dash,
                         vars = nm_6,
                         data = df_rf_6)
                         # n = c(100, 600))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_6)
```


```{r}
perfectPartialPlot(df = pd_df_6, x = nm_6, y = "green")
```








```{r}
ImpData_missRanger_rf_goal6_dash <- as.data.frame(importance(missRanger_rf_goal6_dash))
ImpData_missRanger_rf_goal6_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal6_dash)



ImpData_missRanger_rf_goal6_dash_highest_mse <- ImpData_missRanger_rf_goal6_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal6_dash_highest_mse <- ImpData_missRanger_rf_goal6_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal6_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.5) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```





Goal 7 

Indicators

- Population with access to electricity (%)
- Population with access to clean fuels and technology for cooking (%)
- CO₂ emissions from fuel combustion per total electricity output (MtCO₂/TWh)
- Share of renewable energy in total primary energy supply (%)




```{r}
missRanger_rf_goal7_dash <- randomForest(goal_7_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal7_dash
```


```{r}
df_rf_7 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal7_dash))

```





```{r}
imp_df_7 <- data.frame(importance(missRanger_rf_goal7_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_7 <- imp_df_7 %>% 
  mutate(names = rownames(imp_df_7)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_7 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
   theme(plot.caption = element_text(face = "bold"),
        axis.text.y  = element_text(size = 5, color = "black")) 

```

```{r}
# Save top predictor names as character vector
nm_7 <- as.character(imp_df_7$names)[1:8]
# Get partial depedence values for top predictors
pd_df_7 <- partial_dependence(fit = missRanger_rf_goal7_dash,
                         vars = nm_7,
                         data = df_rf_7)
                         # n = c(100, 700))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_7)
```


```{r}
perfectPartialPlot(df = pd_df_7, x = nm_7, y = "green")
```

```{r}
ImpData_missRanger_rf_goal7_dash <- as.data.frame(importance(missRanger_rf_goal7_dash))
ImpData_missRanger_rf_goal7_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal7_dash)









ImpData_missRanger_rf_goal7_dash_highest_mse <- ImpData_missRanger_rf_goal7_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal7_dash_highest_mse <- ImpData_missRanger_rf_goal7_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal7_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```

```{r}
s <- ggplot(sdg_report_classifier_data_missRanger_sdg_indicators_isolation, aes(x = 	
renewable_energy_share_in_the_total_final_energy_consumption_percent,
                                                y = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation)), label = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation)) +
  geom_point()

ggplotly(s)
```

```{r}
renewable<- sdg_indicators %>% 
  select(geo_area_name, renewable_energy_share_in_the_total_final_energy_consumption_percent,proportion_of_population_with_primary_reliance_on_clean_fuels_and_technology_percent, proportion_of_population_with_access_to_electricity_by_urban_rural_percent )
```

```{r}
r <- ggplot(sdg_report_classifier_data_missRanger_sdg_indicators_isolation, aes(x = proportion_of_population_with_primary_reliance_on_clean_fuels_and_technology_percent, y = 
       renewable_energy_share_in_the_total_final_energy_consumption_percent), label = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation)) +
  
  geom_point()

ggplotly(r, tooltip = rownames(sdg_report_classifier_data_missRanger_sdg_indicators_isolation))
```

Goal 8 

Indicators

- Adjusted GDP growth (%)
- Victims of modern slavery (per 1,000 population)
- Adults with an account at a bank or other financial institution or with a mobile-money-service provider (% of population aged 15 or over)
- Unemployment rate (% of total labor force, ages 15+)
- Fundamental labor rights are effectively guaranteed (worst 0–1 best)
- Fatal work-related accidents embodied in imports (per 100,000 population)
- Employment-to-population ratio (%)
- Youth not in employment, education or training (NEET) (% of population aged 15 to 29)




```{r}
# row_names_df_to_remove<-c("Singapore","Cuba")
# 
# 
# 
# sdg_report_classifier_data_missRanger_sdg_indicators_isolation_no_sing <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation[!(row.names(sdg_report_classifier_data_missRanger_sdg_indicators_isolation) %in% row_names_df_to_remove),]
```


```{r}
missRanger_rf_goal8_dash<- randomForest(goal_8_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal8_dash
```


```{r}
df_rf_8 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal8_dash))

```





```{r}
imp_df_8 <- data.frame(importance(missRanger_rf_goal8_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_8 <- imp_df_8 %>% 
  mutate(names = rownames(imp_df_8)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_8 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_8 <- as.character(imp_df_8$names)[1:12]
# Get partial depedence values for top predictors
pd_df_8 <- partial_dependence(fit = missRanger_rf_goal8_dash,
                         vars = nm_8,
                         data = df_rf_8)
                         # n = c(100, 800))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_8)
```


```{r}
perfectPartialPlot(df = pd_df_8, x = nm_8, y = "green")
```















```{r}
ImpData_missRanger_rf_goal8_dash <- as.data.frame(importance(missRanger_rf_goal8_dash))
ImpData_missRanger_rf_goal8_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal8_dash)








ImpData_missRanger_rf_goal8_dash_highest_mse <- ImpData_missRanger_rf_goal8_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal8_dash_highest_mse <- ImpData_missRanger_rf_goal8_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal8_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```



Goal 9 


Indicators

- Population using the internet (%)
- Mobile broadband subscriptions (per 100 population)
- Logistics Performance Index: Quality of trade and transport-related infrastructure (worst 1-5 best)
- The Times Higher Education Universities Ranking: Average score of top 3 universities (worst 0-100 best)
- Articles published in academic journals (per 1,000 population)
- Expenditure on research and development (% of GDP)
- Researchers (per 1,000 employed population)
- Triadic patent families filed (per million population)
- Gap in internet access by income (percentage points)
- Female share of graduates from STEM fields at the tertiary level (%)


```{r}
missRanger_rf_goal9_dash<- randomForest(goal_9_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal9_dash
```


```{r}
df_rf_9 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal9_dash))

```





```{r}
imp_df_9 <- data.frame(importance(missRanger_rf_goal9_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_9 <- imp_df_9 %>% 
  mutate(names = rownames(imp_df_9)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_9 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_9 <- as.character(imp_df_9$names)[1:16]
# Get partial depedence values for top predictors
pd_df_9 <- partial_dependence(fit = missRanger_rf_goal9_dash,
                         vars = nm_9,
                         data = df_rf_9)
                         # n = c(100, 900))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_9)
```


```{r}
perfectPartialPlot(df = pd_df_9, x = nm_9, y = "green")
```













```{r}
ImpData_missRanger_rf_goal9_dash <- as.data.frame(importance(missRanger_rf_goal9_dash))
ImpData_missRanger_rf_goal9_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal9_dash)







ImpData_missRanger_rf_goal9_dash_highest_mse <- ImpData_missRanger_rf_goal9_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal9_dash_highest_mse <- ImpData_missRanger_rf_goal9_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal9_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```


```{r}
getTree(missRanger_rf_goal9_dash, labelVar = TRUE)
```


Goal 10 

Indicators

- Gini coefficient
- Palma ratio
- Elderly poverty rate (% of population aged 66 or over)


```{r}
missRanger_rf_goal10_dash<- randomForest(goal_10_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal10_dash
```




```{r}
df_rf_10 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal10_dash))

```





```{r}
imp_df_10 <- data.frame(importance(missRanger_rf_goal10_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_10 <- imp_df_10 %>% 
  mutate(names = rownames(imp_df_10)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_10 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_10 <- as.character(imp_df_10$names)[12:18]
# Get partial depedence values for top predictors
pd_df_10 <- partial_dependence(fit = missRanger_rf_goal10_dash,
                         vars = nm_10,
                         data = df_rf_10)
                         # n = c(100, 1000))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_10)
```


```{r}
perfectPartialPlot(df = pd_df_10, x = nm_10, y = "green")
```














```{r}
ImpData_missRanger_rf_goal10_dash <- as.data.frame(importance(missRanger_rf_goal10_dash))
ImpData_missRanger_rf_goal10_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal10_dash)



ImpData_missRanger_rf_goal10_dash





ImpData_missRanger_rf_goal10_dash_highest_mse <- ImpData_missRanger_rf_goal10_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal10_dash_highest_mse <- ImpData_missRanger_rf_goal10_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal10_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```

Goal 11


Indicators

- Proportion of urban population living in slums (%)
- Annual mean concentration of particulate matter of less than 2.5 microns in diameter (PM2.5) (μg/m³)
- Access to improved water source, piped (% of urban population)
- Satisfaction with public transport (%)
- Population with rent overburden (%)




```{r}
missRanger_rf_goal11_dash<- randomForest(goal_11_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal11_dash
```


```{r}
df_rf_11 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal11_dash))

```





```{r}
imp_df_11 <- data.frame(importance(missRanger_rf_goal11_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_11 <- imp_df_11 %>% 
  mutate(names = rownames(imp_df_11)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_11 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy",
       caption = "sethdobson.netlify.com") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_11 <- as.character(imp_df_11$names)[1:8]
# Get partial depedence values for top predictors
pd_df_11 <- partial_dependence(fit = missRanger_rf_goal11_dash,
                         vars = nm_11,
                         data = df_rf_11)
                         # n = c(100, 1100))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_11)
```


```{r}
perfectPartialPlot(df = pd_df_11, x = nm_11, y = "green")
```





















```{r}
ImpData_missRanger_rf_goal11_dash <- as.data.frame(importance(missRanger_rf_goal11_dash))
ImpData_missRanger_rf_goal11_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal11_dash)



ImpData_missRanger_rf_goal11_dash





ImpData_missRanger_rf_goal11_dash_highest_mse <- ImpData_missRanger_rf_goal11_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal11_dash_highest_mse <- ImpData_missRanger_rf_goal11_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal11_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```




Goal 12 

Indicators

- Municipal solid waste (kg/capita/day)
- Electronic waste (kg/capita)
- Production-based SO₂ emissions (kg/capita)
- SO₂ emissions embodied in imports (kg/capita) 
- Production-based nitrogen emissions (kg/capita)
- Nitrogen emissions embodied in imports (kg/capita)
- Exports of plastic waste (kg/capita)
- Non-recycled municipal solid waste (kg/capita/day)




```{r}
missRanger_rf_goal12_dash<- randomForest(goal_12_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE, ntree = 500)
```


```{r}
missRanger_rf_goal12_dash
```



```{r}
df_rf_12 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal12_dash))

```





```{r}
imp_df_12 <- data.frame(importance(missRanger_rf_goal12_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_12 <- imp_df_12 %>% 
  mutate(names = rownames(imp_df_12)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_12 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy",
       caption = "sethdobson.netlify.com") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_12 <- as.character(imp_df_12$names)[1:12]
# Get partial depedence values for top predictors
pd_df_12 <- partial_dependence(fit = missRanger_rf_goal12_dash,
                         vars = nm_12,
                         data = df_rf_12)
                         # n = c(100, 1200))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_12)
```


```{r}
perfectPartialPlot(df = pd_df_12, x = nm_12, y = "green")
```














```{r}
ImpData_missRanger_rf_goal12_dash <- as.data.frame(importance(missRanger_rf_goal12_dash))
ImpData_missRanger_rf_goal12_dash$Var.Names <- row.names(ImpData_missRanger_rf_goal12_dash)



ImpData_missRanger_rf_goal12_dash





ImpData_missRanger_rf_goal12_dash_highest_mse <- ImpData_missRanger_rf_goal12_dash %>% 
  slice_max(MeanDecreaseAccuracy, n = 15)


```

```{r}
ImpData_missRanger_rf_goal12_dash_highest_mse <- ImpData_missRanger_rf_goal12_dash_highest_mse %>% mutate(Var.Names = fct_reorder(Var.Names, .[['MeanDecreaseAccuracy']]))
```


```{r}
ggplot(ImpData_missRanger_rf_goal12_dash_highest_mse, aes(x=Var.Names, y=`MeanDecreaseAccuracy`)) +
  geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=`MeanDecreaseAccuracy`), color="skyblue") +
  geom_point(aes(size = MeanDecreaseGini), color="blue", alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    legend.position="bottom",
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```



Goal 13

- CO₂ emissions from fossil fuel combustion and cement production (tCO2/capita)
- CO₂ emissions embodied in imports (tCO₂/capita)
- CO₂ emissions embodied in fossil fuel exports (kg/capita)
- Carbon Pricing Score at EUR60/tCO₂ (%, worst 0-100 best)

* Maybe make yellow = red for this goal


```{r}
missRanger_rf_goal13_dash<- randomForest(goal_13_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal13_dash
```


```{r}
df_rf_13 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal13_dash))

```





```{r}
imp_df_13 <- data.frame(importance(missRanger_rf_goal13_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_13 <- imp_df_13 %>% 
  mutate(names = rownames(imp_df_13)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_13 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy",
       caption = "sethdobson.netlify.com") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_13 <- as.character(imp_df_13$names)[1:12]
# Get partial depedence values for top predictors
pd_df_13 <- partial_dependence(fit = missRanger_rf_goal13_dash,
                         vars = nm_13,
                         data = df_rf_13)
                         # n = c(100, 1300))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_13)
```


```{r}
perfectPartialPlot(df = pd_df_13, x = nm_13, y = "yellow")
```





Goal 14

Indicators

- Mean area that is protected in marine sites important to biodiversity (%) 
- Ocean Health Index: Clean Waters score (worst 0-100 best)
- Fish caught from overexploited or collapsed stocks (% of total catch)
- Fish caught by trawling or dredging (%)
- Fish caught that are then discarded (%)
- Marine biodiversity threats embodied in imports (per million population)


```{r}
missRanger_rf_goal14_dash<- randomForest(goal_14_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal14_dash
```


```{r}
df_rf_14 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal14_dash))

```





```{r}
imp_df_14 <- data.frame(importance(missRanger_rf_goal14_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_14 <- imp_df_14 %>% 
  mutate(names = rownames(imp_df_14)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_14 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy",
       caption = "sethdobson.netlify.com") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_14 <- as.character(imp_df_14$names)[1:12]
# Get partial depedence values for top predictors
pd_df_14 <- partial_dependence(fit = missRanger_rf_goal14_dash,
                         vars = nm_14,
                         data = df_rf_14)
                         # n = c(100, 1400))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_14)
```


```{r}
perfectPartialPlot(df = pd_df_14, x = nm_14, y = "yellow")
```


Goal 16 


```{r}
missRanger_rf_goal16_dash<- randomForest(goal_16_dash ~ ., data = sdg_report_classifier_data_missRanger_sdg_indicators_isolation, 
                   importance = TRUE)
```


```{r}
missRanger_rf_goal16_dash
```


```{r}
df_rf_16 <- sdg_report_classifier_data_missRanger_sdg_indicators_isolation %>% 
  mutate(predicted = predict(missRanger_rf_goal16_dash))

```





```{r}
imp_df_16 <- data.frame(importance(missRanger_rf_goal16_dash, scale = FALSE, type = 1))
# Tidy up and sort the data frame
imp_df_16 <- imp_df_16 %>% 
  mutate(names = rownames(imp_df_16)) %>% 
  arrange(desc(MeanDecreaseAccuracy))
# Plot mean decreased accuracy
imp_df_16 %>% 
  top_n(10, MeanDecreaseAccuracy) %>% 
  ggplot(aes(x = reorder(names, MeanDecreaseAccuracy),y = MeanDecreaseAccuracy)) +
  geom_col() +
  coord_flip() +
  labs(title = "Variable Importance, Sonar Dataset",
       subtitle = "Random Forests (N = 500)",
       x= "",
       y= "Mean Decrease in Accuracy",
       caption = "sethdobson.netlify.com") +
  theme(plot.caption = element_text(face = "italic"))

```

```{r}
# Save top predictor names as character vector
nm_16 <- as.character(imp_df_16$names)[1:12]
# Get partial depedence values for top predictors
pd_df_16 <- partial_dependence(fit = missRanger_rf_goal16_dash,
                         vars = nm_16,
                         data = df_rf_16)
                         # n = c(100, 1600))
```


```{r}
# Plot partial dependence using edarf
plot_pd(pd_df_16)
```


```{r}
perfectPartialPlot(df = pd_df_16, x = nm_16, y = "green")
```

```{r}

```


